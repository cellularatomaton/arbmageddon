<!DOCTYPE html>
<html>
<head>
    <title>Arbmageddon</title>
    <script type="text/javascript" src="vis.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.5"></script>
    <link href="vis.css" rel="stylesheet" type="text/css" />
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <style type="text/css">
        .app-container {
            position: absolute;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: black;
            color: white;
        }
        .flex-row {
            display: flex; /* or inline-flex */
            flex-direction: row;
        }
        .flex-col {
            display: flex; /* or inline-flex */
            flex-direction: column;
            /* height: 100%; */
        }
        .flex-grow {
            flex-grow: 1; /* default 0 */
        }
        .flex-wrap {
            flex-wrap: wrap;
        }
        .flex-stretch {
            align-items: stretch;
        }
        .flex-center {
            align-items: center;
        }
        .flex-justify {
            justify-content: space-around;
        }
        .arb-list {
            overflow-y: auto;
        }
        .operation {
            margin: 5px;
            padding: 5px;
        }
        .selected {
            background-color: aqua;
        }
        .buy-convert-op {
            border: solid;
            border-width: 2px;
            border-color:greenyellow;
            color: greenyellow;
        }
        .buy-op {
            border: solid;
            border-width: 2px;
            border-color: aqua;
            color: aqua;
        }
        .sell-op {
            border: solid;
            border-width: 2px;
            border-color:red;
            color: red;
        }
        .sell-convert-op {
            border: solid;
            border-width: 2px;
            border-color: orange;
            color: orange;
        }
        .center-contents {
            text-align: center;
            align-content: center;
        }
        .op-title {
            text-align: center;
        }
        .arb-good {
            color: greenyellow;
        }
        .arb-bad {
            color: red;
        }
        .arb-neutral {
            border: solid;
            border-width: 2px;
            border-color: white;
            color: white;
        }
        .full-width {
            width: 100%;
        }
        .elbow-room {
            margin: 5px;
            padding: 5px;
        }
    </style>
    <script type="text/x-template" id="operation-template">
        <div class="elbow-room flex-col">
            <div>
                <h4 class="op-title" v-if="side === 'buy'">{{ title }}: [{{ operation.exchange }}] {{ operation.hub }} -> {{ operation.market }}</h4>
                <h4 class="op-title" v-else>{{ title }}: [{{ operation.exchange }}] {{ operation.market }} -> {{ operation.hub }}</h4>
            </div>
            <div class="flex-grow flex-row flex-wrap flex-stretch elbow-room">
                <div class="flex-grow">
                    <span>VWAP</span>
                    <span>{{ operation.price.toFixed(8) }}</span>
                </div>
                <div class="flex-grow">
                    <span>Duration</span>
                    <span>{{ (operation.duration/1000).toFixed(0) }}</span>
                </div>
                <div class="flex-grow">
                    <span>Position</span>
                    <span>{{ operation.position }}</span>
                </div>
            </div>
            <div class="flex-grow flex-row flex-wrap flex-stretch elbow-room">
                <div class="flex-grow">
                    <span>Open Bids</span>
                    <span>{{ operation.open_bids }}</span>
                </div>
                <div class="flex-grow">
                    <span>Open Asks</span>
                    <span>{{ operation.open_asks }}</span>
                </div>
            </div>
            <button class="elbow-room">Execute!</button>
        </div>
    </script>
</head>
<body>
    <div id="app-dash" class="app-container flex-col">
        <div>
            <div class="flex-row flex-stretch">
                <execution-component v-if="selected_inst && selected_inst.type === 1" side="buy" class="buy-convert-op flex-grow" title="Buy Convert" :operation="selected_inst.convert"></execution-component>
                <execution-component v-if="selected_inst" side="buy" class="buy-op flex-grow" title="Buy" :operation="selected_inst ? selected_inst.buy : null"></execution-component>
                <execution-component v-if="selected_inst" side="sell" class="sell-op flex-grow" title="Sell" :operation="selected_inst ? selected_inst.sell: null"></execution-component>
                <execution-component v-if="selected_inst && selected_inst.type === 2" side="sell" class="sell-convert-op flex-grow" title="Sell Convert" :operation="selected_inst.convert"></execution-component>
            </div>
        </div>
        <div>
            <div class="flex-row flex-center">
                <div class="flex-grow center-contents">
                    <span>Basis Size (BTC):</span>
                    <input v-model="basis_size" placeholder="0.1">
                </div>
                <div class="flex-grow center-contents" v-bind:class="{ 'arb-good': arb_is_good(), 'arb-bad': !arb_is_good() }"> 
                    <h3>Opportunity Window: {{ (selected_inst.opportunity_window/1000).toFixed(0) }} s</h3>
                </div>
                <div class="flex-grow center-contents" v-bind:class="{ 'arb-good': arb_is_good(), 'arb-bad': !arb_is_good() }"> 
                    <h3>Execution Time: {{ (selected_inst.sum_of_durations/1000).toFixed(0) }} s</h3>
                </div>
                
            </div>
        </div>
        <div class="flex-row flex-grow">
            <div class="flex-col elbow-room">
                <div>
                    <div class="flex-row">
                        <div class="flex-grow">
                            <input type="checkbox" id="direct-checkbox" value="false" v-model="show_direct">
                            <label for="direct-checkbox">Direct</label>
                        </div>
                        <div class="flex-grow">
                            <input type="checkbox" id="conversion-checkbox" value="true" v-model="show_conversion">
                            <label for="conversion-checkbox">Conversion</label>
                        </div>   
                    </div>
                    <div class="flex-row">
                        <div class="flex-grow">
                                <input type="checkbox" id="cross-exchange-checkbox" value="false" v-model="show_cross_exchange">
                                <label for="cross-exchange-checkbox">Cross Exchange</label>
                            </div>
                        <div class="flex-grow">
                            <span>Spread Target:</span>
                            <input v-model="spread_filter" placeholder="2">
                        </div>
                    </div>
                </div>
                <div class="flex-grow arb-list">
                    <table>
                        <thead>
                            <th>Arb</th>
                            <th>Spread</th>
                        </thead>
                        <tbody>
                            <tr v-for="inst in get_filtered_arbs(arb_list)">
                                <td>{{ inst.id }}</td>
                                <td><button 
                                    v-on:click="set_multicharts(inst)"  
                                    v-bind:class="{ selected: inst.selected }">{{ inst_spread(inst) }}</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flex-grow elbow-room">
                <iframe :src="multicharts_url" height="100%" width="100%"></iframe>
            </div>
        </div>
    </div>
    <script>
        let exch_map = {};
        const arb_map = {};
        
        const get_coinigy_symbol = function(op){
            return `${exch_map[op.exchange]}:${op.market}${op.hub}`;
        }
        const get_mcc_query_string = function(inst){
            if(inst){
                const buy = get_coinigy_symbol(inst.buy);
                const sell = get_coinigy_symbol(inst.sell);
                if(inst.type === 0){ // Buy Spread
                    return `?chart=${buy}&chart=${sell}&chart=${sell}-${buy}`;
                }else { // Conversion
                    const convert = get_coinigy_symbol(inst.convert);
                    if(inst.type === 1){ // Origin Conversion
                        return `?chart=${buy}&chart=${sell}&chart=${convert}&chart=${sell}-${buy}*${convert}`;
                    }else if(inst.type === 2){ // Destination Conversion
                        return `?chart=${buy}&chart=${sell}&chart=${convert}&chart=${sell}*${convert}-${buy}`;
                    }else{
                        return null;
                    }
                }
            }
        }
        const op_symbol_match = function(symbol, op){
            return op.exchange.startsWith(symbol) || 
                op.hub.startsWith(symbol) ||
                op.market.startsWith(symbol);
        }
        const inst_symbol_match = function(symbol, inst){
            const convert_match = inst.convert ? op_symbol_match(symbol, inst.convert) : false;
            return convert_match ||
                op_symbol_match(symbol, inst.buy) ||
                op_symbol_match(symbol, inst.sell);
        }
        Vue.component('execution-component', {
            template: '#operation-template',
            props: ['title', 'side', 'operation']
        });
        const appDash = new Vue({
            el: '#app-dash',
            data: {
                exchanges: [],
                arb_list: [],
                // arb_map: [],
                selected_inst: null,
                multicharts_url: 'https://www.multicoincharts.com/?chart=ETHBTC&chart=XRPETH&chart=XRPBTC&chart=XRPBTC/XRPETH-ETHBTC',
                show_cross_exchange: false,
                show_direct: false,
                show_conversion: true,
                symbol_filter: 'SYM',
                spread_filter: 3.0,
                basis_size: 0.1
            },
            methods: {
                get_exchanges: function(){
                    return new Promise(function(resolve, reject) {
                        Vue.http.get('/graph/exchanges').then(response => {
                            appDash.exchanges = response.body;
                            exch_map = appDash.exchanges.reduce(function(map, exch){
                                map[exch.id] = exch.name;
                                return map;
                            }, {});
                            resolve();
                        }, response => {
                            reject();
                        });
                    });
                },
                get_filtered_arbs: function(){
                    return appDash.arb_list.filter(function (inst) {
                        const is_cross_exchange = inst.buy.exchange !== inst.sell.exchange;
                        const cross_exchange_passes = appDash.show_cross_exchange ? is_cross_exchange : !is_cross_exchange;
                        const is_direct = inst.type === 0;
                        const direct_passes = appDash.show_direct ? is_direct : !is_direct;
                        const is_conversion = inst.type !== 0;
                        const conversion_passes = appDash.show_conversion ? is_conversion : !is_conversion;
                        const spread_passes = Number.parseFloat(appDash.spread_filter)/100 < inst.spread;
                        return cross_exchange_passes && (direct_passes && conversion_passes) && spread_passes;
                    });
                },
                arb_is_good(){
                    const inst = appDash.selected_inst;
                    return 0 < inst.opportunity_window && inst.sum_of_durations < inst.opportunity_window;
                },
                inst_spread: function(i) { return `${(i.spread*100).toFixed(2)}%`; },
                inst_string: function(inst){
                    return get_inst_string(inst);
                },
                set_multicharts: function(inst){
                    if(inst){
                        const query_string = get_mcc_query_string(inst);
                        appDash.multicharts_url = `https://www.multicoincharts.com/${query_string}`;
                        inst.selected = true;
                        if(appDash.selected_inst && appDash.selected_inst.selected){
                            appDash.selected_inst.selected = false;
                        }
                        appDash.selected_inst = inst;
                    }
                },
                setup: function(){
                    appDash
                        .get_exchanges()
                        .then(function(){
                            return appDash.setup_websocket();
                        })
                        .then(appDash.sort_loop);
                },
                sort_loop: function(){
                    appDash.arb_list.sort((a, b)=>{
                        return b.spread - a.spread;
                    });
                    setTimeout(appDash.sort_loop, 1000);
                },
                setup_websocket: function(){
                    return new Promise(function(resolve, reject) {
                        const ws = new WebSocket('ws://localhost:8080/');
                        ws.addEventListener('message', function(message){
                            const msg = JSON.parse(message.data);
                            if(msg.type === 'arb'){ // Spread Update
                                const update = msg.data;
                                const instruction = arb_map[update.id];
                                if(instruction){
                                    const target = appDash.spread_filter/100;
                                    if(instruction.spread < target && target < update.spread){
                                        instruction.spread_entered_at = Date.now();
                                    }
                                    instruction.opportunity_window = Date.now() - instruction.spread_entered_at;
                                    instruction.spread = update.spread;
                                    instruction.buy.price = update.buy.price;
                                    instruction.buy.duration = update.buy.duration;
                                    instruction.sell.price = update.sell.price;
                                    instruction.sell.duration = update.sell.duration;
                                    if(instruction.convert){
                                        instruction.convert.price = update.convert.price;
                                        instruction.convert.duration = update.convert.duration;
                                        instruction.sum_of_durations = 
                                            update.buy.duration +
                                            update.sell.duration +
                                            update.convert.duration;
                                    }else{
                                        instruction.sum_of_durations = 
                                            update.buy.duration +
                                            update.sell.duration;
                                    }
                                    
                                }else{
                                    update.spread_entered_at = Date.now();
                                    arb_map[update.id] = update;
                                    appDash.arb_list.push(update);
                                }
                                if(!appDash.selected_inst){
                                    appDash.set_multicharts(appDash.arb_list[0]);
                                }
                            }
                        });
                        resolve();
                    });
                }
            }
        });
        appDash.setup();
    </script>
</body>
</html>